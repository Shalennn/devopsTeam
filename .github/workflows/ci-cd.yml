name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - devops
      - quentin-cli
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - devops
      - main

# Permissions pour √©crire dans le repo
permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # Job 1: Tests & Qualit√©
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Lint with flake8
        run: flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        
      - name: Run PyTest
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest tests/

  # Job 2: Build & S√©curit√©
  build_and_security:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker Image
        run: docker build -t inventory-api .
        
      - name: Check Image Size (< 100MB)
        run: |
          SIZE=$(docker inspect inventory-api --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"
          if [ $SIZE_MB -ge 100 ]; then
            echo "Error: Image size exceeds 100MB limit"
            exit 1
          fi

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'inventory-api'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  # Job 3: Merge quentin-cli ‚Üí devops ‚Üí main ‚Üí deploy (TOUT EN UN)
  auto_merge_chain:
    needs: build_and_security
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/quentin-cli' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: "Step 1: Merge quentin-cli ‚Üí devops"
        run: |
          echo "======================================"
          echo "üîÑ STEP 1: Merge quentin-cli ‚Üí devops"
          echo "======================================"
          git fetch origin devops:devops
          git checkout devops
          git merge origin/quentin-cli --no-ff -m "üîÑ Auto-merge: quentin-cli ‚Üí devops"
          git push origin devops
          echo "‚úÖ Step 1 completed!"
      
      - name: "Step 2: Merge devops ‚Üí main"
        run: |
          echo "======================================"
          echo "üöÄ STEP 2: Merge devops ‚Üí main"
          echo "======================================"
          git fetch origin main:main
          git checkout main
          git merge origin/devops --no-ff -m "üöÄ Auto-merge: devops ‚Üí main"
          git push origin main
          echo "‚úÖ Step 2 completed!"
      
      - name: "Step 3: Deploy to Production"
        run: |
          echo "======================================"
          echo "üéØ STEP 3: Deploy to Production"
          echo "======================================"
          echo "üöÄ D√©ploiement en cours sur le serveur de production..."
          echo "üì¶ Version d√©ploy√©e: ${{ github.sha }}"
          echo "‚úÖ D√©ploiement termin√© avec succ√®s!"

  # Job 4: Merge devops ‚Üí main (si push direct sur devops)
  merge_devops_to_main:
    needs: build_and_security
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/devops' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Merge devops into main
        run: |
          echo "üîÑ Fetching main branch..."
          git fetch origin main:main
          git checkout main
          git merge origin/devops --no-ff -m "üöÄ Auto-merge: devops ‚Üí main"
          git push origin main
          echo "‚úÖ Successfully merged devops into main!"

  # Job 5: D√©ploiement (si push direct sur main)
  deploy:
    needs: build_and_security
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy to Production
        run: |
          echo "üöÄ D√©ploiement en cours sur le serveur de production..."
          echo "üì¶ Version d√©ploy√©e: ${{ github.sha }}"
          echo "‚úÖ D√©ploiement termin√© avec succ√®s!"